transmittalreceipt.php
<?php
    session_start();
    if (isset($_SESSION['EMPNO']) && isset($_SESSION['USERNAME']) && isset($_SESSION["AUTHENTICATED"]) && $_SESSION["AUTHENTICATED"] === true) {
?>

<!doctype html>
<html lang="en" dir="ltr">
    <?php
        include('../../includes/pages.header.php');
    ?>
      <link rel="stylesheet" href="../../assets/datetimepicker/jquery.datetimepicker.css">
      <link rel="stylesheet" href="../../assets/select2/css/select2.min.css">

    <body class="  ">
        <!-- loader Start -->
        <div id="loading">
        <div class="loader simple-loader">
            <div class="loader-body"></div>
        </div>
        </div>
        <!-- loader END -->

        <?php
            include('../../includes/pages.sidebar.php');
            include('../../includes/pages.navbar.php');
        ?>

            <style>
                :root {
                    --primary-color: #ffffffff;
                    --primary-hover: #ffffffff;
                    --secondary-color: #64748b;
                    --success-color: #10b981;
                    --danger-color: #ef4444;
                    --warning-color: #f59e0b;
                    --dark-color: #1f2937;
                    --light-bg: #f8fafc;
                    --border-color: #e2e8f0;
                    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
                    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
                    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
                }

                body {
                    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                    min-height: 100vh;
                }

                label {
                    color: #000000 !important;
                    font-weight: 500;
                    margin-bottom: 0.5rem;
                }

                .form-control, .form-select {
                    color: var(--dark-color) !important;
                    border: 2px solid var(--border-color) !important;
                    border-radius: 8px !important;
                    padding: 0.75rem 1rem !important;
                    font-size: 0.95rem !important;
                    transition: all 0.3s ease !important;
                    background-color: white !important;
                }

                .form-control:focus, .form-select:focus {
                    border-color: var(--primary-color) !important;
                    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1) !important;
                    outline: none !important;
                }

                .form-control:disabled, .form-select:disabled {
                    background-color: #f1f5f9 !important;
                    opacity: 0.7;
                }

                /* Selection box */
                .select2-container--default .select2-selection--single {
                    border: 2px solid var(--border-color) !important;
                    border-radius: 8px !important;
                    height: 46px !important;
                    padding: 0.5rem !important;
                }

                .select2-container--default .select2-selection--single .select2-selection__rendered {
                    color: var(--dark-color) !important;
                    line-height: 28px !important;
                }

                /* Dropdown */
                .select2-dropdown {
                    border: 2px solid var(--border-color) !important;
                    border-radius: 8px !important;
                    box-shadow: var(--shadow-lg) !important;
                }

                .select2-results__option {
                    color: var(--dark-color) !important;
                    padding: 0.75rem 1rem !important;
                }

                /* Optional: Highlighted option */
                .select2-results__option--highlighted {
                    background-color: var(--primary-color) !important;
                    color: white !important;
                }

                .card-container {
                    background: white;
                    border-radius: 16px;
                    box-shadow: var(--shadow-md);
                    padding: 2rem;
                    margin-bottom: 1.5rem;
                    border: 1px solid var(--border-color);
                    transition: transform 0.3s ease, box-shadow 0.3s ease;
                }

                .card-container:hover {
                    transform: translateY(-2px);
                    box-shadow: var(--shadow-lg);
                }

                .section-title {
                    color: var(--dark-color);
                    font-size: 1.25rem;
                    font-weight: 600;
                    margin-bottom: 1rem;
                    padding-bottom: 0.75rem;
                    border-bottom: 2px solid var(--border-color);
                }

                .btn {
                    border-radius: 8px;
                    padding: 0.625rem 1.25rem;
                    font-weight: 500;
                    transition: all 0.3s ease;
                    border: none;
                    font-size: 0.95rem;
                    color: #ffffff !important;
                }

                .btn-primary {
                    background: #82ccf8ff !important;
                    color: #ffffff !important;
                    border: none;
                    padding: 0.625rem 1.25rem;
                    font-weight: 500;
                    transition: all 0.3s ease;
                    border-radius: 8px;
                    font-size: 0.95rem;
                }

                .btn-primary:hover {
                    background: #6bb6ff !important;
                    transform: translateY(-1px);
                    box-shadow: var(--shadow-md);
                }

                .btn-success {
                    background: linear-gradient(135deg, var(--success-color), #059669);
                    color: #ffffff !important;
                    box-shadow: var(--shadow-sm);
                }

                .btn-success:hover {
                    background: linear-gradient(135deg, #059669, #047857);
                    transform: translateY(-1px);
                    box-shadow: var(--shadow-md);
                }

                .btn-danger {
                    background: linear-gradient(135deg, var(--danger-color), #dc2626);
                    color: #ffffff !important;
                    box-shadow: var(--shadow-sm);
                }

                .btn-danger:hover {
                    background: linear-gradient(135deg, #dc2626, #b91c1c);
                    transform: translateY(-1px);
                    box-shadow: var(--shadow-md);
                }

                .table {
                    border-radius: 8px;
                    overflow: hidden;
                    box-shadow: var(--shadow-sm);
                }

                .table thead th {
                    background: #f8f9fa !important;
                    color: #000000 !important;
                    font-weight: 600;
                    padding: 1rem 0.75rem;
                    border: 1px solid #e2e8f0 !important;
                    font-size: 0.875rem;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }

                .table tbody tr {
                    background: #ffffff !important;
                    transition: all 0.3s ease;
                }

                .table tbody tr:hover {
                    background: #f8f9fa !important;
                    transform: scale(1.01);
                }

                .table tbody td {
                    padding: 0.875rem 0.75rem;
                    border-color: #e2e8f0 !important;
                    vertical-align: middle;
                    color: #000000 !important;
                }

                .form-check-input:checked {
                    background-color: var(--primary-color);
                    border-color: var(--primary-color);
                }

                .form-check-input:focus {
                    border-color: var(--primary-color);
                    box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
                }

                hr {
                    border: none;
                    height: 2px;
                    background: linear-gradient(90deg, transparent, var(--border-color), transparent);
                    margin: 1.5rem 0;
                }

                .header-section {
                    background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
                    color: white;
                    padding: 2rem;
                    border-radius: 16px;
                    box-shadow: var(--shadow-lg);
                    margin-bottom: 2rem;
                }

                .header-section h5 {
                    margin: 0;
                    font-size: 1.5rem;
                    font-weight: 600;
                }

                .modal-content {
                    border-radius: 16px;
                    border: none;
                    box-shadow: var(--shadow-lg);
                }

                .modal-header {
                    background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
                    color: white;
                    border-radius: 16px 16px 0 0;
                    border: none;
                }

                .modal-header .btn-close {
                    filter: brightness(0) invert(1);
                }

                .input-group-text {
                    background-color: var(--light-bg);
                    border: 2px solid var(--border-color);
                    color: var(--dark-color);
                }

                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }

                .fade-in {
                    animation: fadeIn 0.6s ease-out;
                }
            </style>

            <div class="container-fluid mt-1">
                <!-- Header -->
                <div class="header-section fade-in">
                    <h5 style="color: blue; font-weight: bold;"><i class="fa-solid fa-file-contract me-2"></i>Transmittal Receipt</h5>
                </div>

                <!-- Row 1 Search -->
                <div class="row">
                    <div class="col-md-12 mt-1">
                        <div class="card-container fade-in">
                            <form id="myForm" method="POST">
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <input type="text" name="transmittalNo" class="form-control" id="transmittalNo" placeholder="Transmittal No." disabled>
                                </div>
                                <div class="col-md-4 justify-content-end">
                                    <button type="button" class="btn btn-block btn-primary w-100" id="searchTransmittalBtn" name="searchTransmittalBtn" onclick="SearchTransmittal();"><i class="fa-solid fa-magnifying-glass"></i> Search Transmittal</button>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-5">
                                    <div class="row mb-3">
                                        <label for="colFormLabel" class="col-sm-1 col-form-label">TO:</label>

                                        <div class="col-sm-10">
                                            <input type="text" class="form-control" name="toRep" id="toRep" placeholder="RECIPIENT NAME">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="row mb-3">
                                        <label for="colFormLabel" class="col-sm-1  col-form-label">FROM:</label>
                                        <div class="col-sm-9 ms-2">
                                            <input type="text" class="form-control" name="fromRep" id="fromRep" placeholder="ISYNERGIESINC"disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Row 2 -->
                <div class="row mt-3">
                    <!-- Particulars Column -->
                    <div class="col-md-6">
                        <div class="card-container fade-in">
                            <form id="transmittalform" method="POST">
                                <div class="head">
                                    <h5 class="section-title"><i class="fa-solid fa-box me-2"></i>Particulars</h5>
                                </div>
                                <div class="alert alert-info mb-4" role="alert">
                                    <i class="fa-solid fa-info-circle me-2"></i>Product Information
                                </div>

                                <div class="row mb-4 mt-2">
                                    <div class="col-md-3">
                                        <input class="form-check-input" type="checkbox" name="isConsignment" id="isConsignment" value="Yes" onclick="isConsignmentBox()">
                                        <label for="isConsignment" class="form-check-label">Consignment</label>
                                    </div>
                                </div>

                                <div class="row mt-2 mb-3">
                                    <div class="col-md-3">
                                        <label for="">Isyn Branch:</label>
                                    </div>
                                    <div class="col-md-9">
                                        <select class="form-select" name="isynBranch" id="isynBranch" onchange="LoadBranch(this.value)">
                                                <option value="" selected>Select</option>
                                                <option value="HEAD OFFICE">HEAD OFFICE</option>
                                            </select>
                                    </div>
                                </div>

                                <div class="mb-2 row" id="consignmentBranchContainer" style="display: None;">
                                    <label class="col-sm-3 col-form-label" for="isynBranch">Branch:</label>
                                    <div class="col-sm-9">
                                        <select class="form-select" name="consignmentBranch" id="consignmentBranch" onchange="forBranchClear();">
                                            <option value="" selected disabled>Select</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row mt-2">
                                    <label class="col-sm-3 col-form-label" for="type">Type:</label>
                                    <div class="col-md-9">
                                        <select class="form-select" name="type" id="type" onchange="LoadCategory(this.value);">
                                                <option value="" selected>Select</option>
                                                <option value="With VAT">With VAT</option>
                                                <option value="Non-VAT">Non-VAT</option>
                                            </select>
                                    </div>
                                </div>

                                <div class="row mt-2">
                                    <label class="col-sm-3 col-form-label" for="category">Category:</label>
                                    <div class="col-sm-9">
                                         <select class="form-select" aria-label="Category" name="category" id="category" onchange="LoadSerialProduct(this.value);">
                                                <option value="" selected>Select</option>
                                                <option value="Battery">Battery</option>
                                                <option value="Cable">Cable</option>
                                                <option value="Cartridge">Cartridge</option>
                                                <option value="Connector">Connector</option>
                                            </select>
                                    </div>
                                </div>

                                <div class="row mt-2 mb-2">
                                    <label class="col-sm-3 col-form-label">Select by:</label>
                                    <div class="col-sm-9">
                                        <div class="row mt-2">
                                            <div class="col-lg-5 col-sm-5">
                                                <div class="form-check">
                                                    <input class="form-check-input me-1" type="radio" value="productName" name="selectBy" id="productName">
                                                    <label class="form-check-label" for="productName">Product Name</label>
                                                </div>
                                            </div>
                                            <div class="col-lg-4 col-sm-4">
                                                <div class="form-check">
                                                    <input class="form-check-input me-1" type="radio" value="serial" name="selectBy" id="serialNo">
                                                    <label class="form-check-label" for="serialNo">Serial No.</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mt-2">
                                    <label class="col-sm-3 col-form-label" for="SerialProduct" id="SerialProdlbl">Serial:</label>
                                    <div class="col-sm-9">
                                        <select id="SerialProduct" name="SerialProduct" class="form-select" onchange="LoadProductSINo(this.value);">
                                        </select>
                                    </div>
                                </div>

                                <div class="row mt-2">
                                    <label class="col-sm-3 col-form-label" for="SINo">Supplier SI:</label>
                                    <div class="col-sm-9">
                                        <select id="SINo" name="SINo" class="form-select" onchange="LoadProductSummary();">
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Product Summary Column -->
                    <div class="col-md-6">
                        <div class="card-container fade-in">
                            <form id="summary" method="POST">
                                <div class="head">
                                    <h5 class="section-title"><i class="fa-solid fa-chart-line me-2"></i>Product Summary</h5>
                                </div>
                                <div class="row mt-2">
                                    <label for="psSupplierSI" class="col-md-3 form-label">Supplier SI:</label>
                                    <div class="col-md-9">
                                        <input type="text" id="psSupplierSI" name="psSupplierSI" class="form-control" disabled>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <label for="psSerialNo" class="col-md-3 form-label">Serial No.:</label>
                                    <div class="col-md-9">
                                        <input type="text" id="psSerialNo" name="psSerialNo" class="form-control" disabled>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <label for="psProduct" class="col-md-3 form-label">Product:</label>
                                    <div class="col-md-9">
                                        <input type="text" id="psProduct" name="psProduct" class="form-control" disabled>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <label for="psSupplier" class="col-md-3 form-label">Supplier:</label>
                                    <div class="col-md-9">
                                        <input type="text" id="psSupplier" name="psSupplier" class="form-control" disabled>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <label for="psSRP" class="col-md-3 form-label">SRP:</label>
                                    <div class="col-md-9">
                                        <input type="text" id="psSRP" name="psSRP" class="form-control" disabled>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <label for="psQuantity" class="col-md-3 form-label">Quantity:</label>
                                    <div class="col-md-9">
                                        <input type="text" id="psQuantity" name="psQuantity" class="form-control" disabled>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <label for="psDealerPrice" class="col-md-3 form-label">Dealer's Price:</label>
                                    <div class="col-md-9">
                                        <input type="text" id="psDealerPrice" name="psDealerPrice" class="form-control" disabled>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <label for="psTotalPrice" class="col-md-3 form-label">Total Price:</label>
                                    <div class="col-md-9">
                                        <input type="text" id="psTotalPrice" name="psTotalPrice" class="form-control" disabled>
                                    </div>                                    
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!--Row 3-->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card-container fade-in">
                            <form id="transmittalform2" method="POST" class="needs-validation" novalidate>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label for="">Quantity:</label>
                                        </div>
                                        <div class="col-md-9">
                                            <input type="number" class="form-control" name="saleQty" id="saleQty" placeholder="0" min="1" onchange="ComputeAvailQty(this.value);">
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label>
                                                <input class="form-check-input" type="checkbox" name="isEditSRP" id="isEditSRP" onclick="isEditSRPBTN()"> Edit SRP
                                            </label>
                                        </div>
                                        <div class="col-md-9">
                                            <input type="text" class="form-control" name="finalSRP" id="finalSRP" onchange="formatInput(this);" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>


                <!-- Row 4 -->
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="card-container fade-in">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0"><i class="fa-solid fa-list me-2"></i>Items List</h6>
                                    <div>
                                        <button type="button" class="btn btn-success px-3 py-2 me-2" id="addbtn" name="addbtn" onclick="addItem();"><i class="fa-solid fa-plus me-1"></i> Add</button>
                                        <button type="button" class="btn btn-danger" id="cancelProduct" name="cancelProduct" onclick="cancelProduct()" disabled><i class="fa-solid fa-circle-xmark me-1"></i> Cancel Product</button>
                                    </div>
                                </div>
                            <table id="itemsTbl" style="width:100%;" class="table table-hover table-bordered">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Quantity</th>
                                        <th>SRP</th>
                                        <th>SI No</th>
                                        <th>Serial No</th>
                                        <th>Product</th>
                                        <th>Supplier</th>
                                        <th>Category</th>
                                        <th>Type</th>
                                        <th>Branch</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsList">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Row 5 -->

                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="card-container fade-in">
                            <form id="myForm2" method="POST">
                                <h6 class="section-title"><i class="fa-solid fa-comment-dots me-2"></i>Additional Details</h6>
                                <div class="row mb-4">
                                    <div class="col-md-12">
                                        <label for="remarks" class="form-label fw-bold">Remarks:</label>
                                        <textarea id="remarks" name="remarks" class="form-control" rows="3" placeholder="Enter any additional remarks..."></textarea>
                                    </div>
                                </div>

                                <div class="row mb-4 mt-2">
                                    <div class="col-md-3">
                                        <input class="form-check-input" type="checkbox" name="isOtherDetails" id="isOtherDetails" value="Yes" onclick="isOtherDetailsBox()">
                                        <label for="isOtherDetails" class="form-check-label">Other Details</label>
                                    </div>
                                </div>

                                <div class="row mt-2">
                                    <div class="col-6">
                                        <div class="card-container p-3">
                                            <h6 class="section-title mb-3"><i class="fa-solid fa-truck me-2"></i>Carrier Information</h6>
                                            <div class="row mt-2">
                                                <label for="carrier" class="col-md-3 form-label">Carrier:</label>
                                                <div class="col-md-9">
                                                    <input type="text" class="form-control" name="carrier" id="carrier" disabled>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <label for="dateCarrier" class="col-md-3 form-label">Date:</label>
                                                <div class="col-md-9">
                                                    <input type="text" class="form-control" name="dateCarrier" id="dateCarrier" disabled>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card-container p-3">
                                            <h6 class="section-title mb-3"><i class="fa-solid fa-user-check me-2"></i>Receipt Information</h6>
                                            <div class="row mt-2">
                                                <label for="receivedBy" class="col-md-3 form-label">Received by:</label>
                                                <div class="col-md-9">
                                                    <input type="text" class="form-control" name="receivedBy" id="receivedBy" disabled>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <label for="dateReceivedBy" class="col-md-3 form-label">Date:</label>
                                                <div class="col-md-9">
                                                    <input type="text" class="form-control" name="dateReceivedBy" id="dateReceivedBy" disabled>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <div class="buttons d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-primary btn-lg px-4" id="submitBtn" name="submitBtn" onclick="SubmitBtn();"><i class="fa-solid fa-floppy-disk me-2"></i> Submit Transmittal</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="SearchTransmittalMDL" data-bs-backdrop="true" data-bs-keyboard="false" tabindex="-1" aria-labelledby="SearchTransmittal" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">Search Transmittal</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="card-container mb-3">
                                <div class="row align-items-end">
                                    <div class="col-md-6">
                                        <label for="searchNameFrom" class="form-label fw-bold">Name From</label>
                                        <input type="text" name="searchNameFrom" id="searchNameFrom" class="form-control" placeholder="Enter sender name...">
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-primary w-100" id="transmittalSearchBtn" name="transmittalSearchBtn" onclick="TransmittalSearch();"><i class="fa-solid fa-magnifying-glass me-2"></i> Search</button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-secondary w-100" id="transmittalClearBtn" name="transmittalClearBtn" onclick="ClearSearch();"><i class="fa-solid fa-times me-2"></i> Clear</button>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table id="listTbl" class="table table-hover table-bordered" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th width="20%">TRANS NO.</th>
                                            <th width="20%">CLIENT</th>
                                            <th width="20%">DATE</th>
                                            <th width="20%">OUT</th>
                                            <th width="20%">SI No.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listList">
                                    </tbody>
                                </table>
                            </div>
                            <div class="row mt-4">
                                <div class="col-12">
                                    <button class="btn btn-success btn-lg w-100" type="button" id="rePrint" name="rePrint" onclick="RePrint();" disabled><i class="fa-solid fa-retweet me-2"></i> REPRINT</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <?php
            include('../../includes/pages.footer.php');
        ?>

        <script src="../../assets/datetimepicker/jquery.datetimepicker.full.js"></script>
        <script src="../../assets/select2/js/select2.full.min.js"></script>
        <script src="../../js/inventorymanagement/transmittalreceipt.js?<?= time() ?>"></script>

        <script>
            $(document).ready(function() {
                // Validation: TO and FROM recipient fields - letters only
                $('#toRep, #fromRep').on('input', function() {
                    var value = $(this).val();
                    // Remove any characters that are not letters (including spaces and special characters)
                    var lettersOnly = value.replace(/[^a-zA-Z\s]/g, '');
                    if (value !== lettersOnly) {
                        $(this).val(lettersOnly);
                    }
                });

                // Validation: Edit SRP field - numbers only (no letters or special characters)
                $('#finalSRP').on('input', function() {
                    var value = $(this).val();
                    // Remove any characters that are not numbers or decimal point
                    var numbersOnly = value.replace(/[^0-9.]/g, '');
                    
                    // Ensure only one decimal point
                    var parts = numbersOnly.split('.');
                    if (parts.length > 2) {
                        numbersOnly = parts[0] + '.' + parts.slice(1).join('');
                    }
                    
                    // Limit decimal places to 2
                    if (parts.length === 2 && parts[1].length > 2) {
                        numbersOnly = parts[0] + '.' + parts[1].substring(0, 2);
                    }
                    
                    if (value !== numbersOnly) {
                        $(this).val(numbersOnly);
                    }
                });

                // Date picker configuration: Carrier and Received By dates - no future dates
                setTimeout(function() {
                    // Initialize carrier date picker
                    $('#dateCarrier').datetimepicker({
                        format: 'Y-m-d',
                        timepicker: false,
                        maxDate: 0, // 0 means today, prevents future dates
                        scrollInput: false,
                        onSelectDate: function(ct, $input) {
                            // When carrier date is selected, update received date min date
                            var carrierDate = $input.val();
                            updateReceivedDateMinDate(carrierDate);
                        }
                    });
                    
                    // Initialize received date picker
                    $('#dateReceivedBy').datetimepicker({
                        format: 'Y-m-d',
                        timepicker: false,
                        maxDate: 0, // 0 means today, prevents future dates
                        scrollInput: false
                    });
                    
                    // Function to update received date minimum date
                    function updateReceivedDateMinDate(carrierDate) {
                        var receivedDate = $('#dateReceivedBy').val();
                        
                        if (carrierDate) {
                            // Update received date picker to have minimum date of carrier date
                            try {
                                $('#dateReceivedBy').datetimepicker('destroy');
                            } catch(e) {
                                // Ignore if already destroyed
                            }
                            
                            $('#dateReceivedBy').datetimepicker({
                                format: 'Y-m-d',
                                timepicker: false,
                                maxDate: 0, // No future dates
                                minDate: carrierDate, // Must be after or equal to carrier date
                                scrollInput: false
                            });
                            
                            // If received date is already set and is before carrier date, clear it
                            if (receivedDate) {
                                var carrierDateObj = new Date(carrierDate);
                                var receivedDateObj = new Date(receivedDate);
                                
                                if (receivedDateObj < carrierDateObj) {
                                    alert('Received date must be after or equal to carrier date.');
                                    $('#dateReceivedBy').val('');
                                }
                            }
                        } else {
                            // If carrier date is cleared, remove min date restriction
                            try {
                                $('#dateReceivedBy').datetimepicker('destroy');
                            } catch(e) {
                                // Ignore if already destroyed
                            }
                            
                            $('#dateReceivedBy').datetimepicker({
                                format: 'Y-m-d',
                                timepicker: false,
                                maxDate: 0, // No future dates
                                scrollInput: false
                            });
                        }
                    }
                    
                    // When carrier date changes, update received date minimum date
                    $('#dateCarrier').on('change', function() {
                        var carrierDate = $(this).val();
                        updateReceivedDateMinDate(carrierDate);
                    });
                    
                    // Validate received date when it changes
                    $('#dateReceivedBy').on('change', function() {
                        var carrierDate = $('#dateCarrier').val();
                        var receivedDate = $(this).val();
                        
                        if (carrierDate && receivedDate) {
                            // Compare dates
                            var carrierDateObj = new Date(carrierDate);
                            var receivedDateObj = new Date(receivedDate);
                            
                            // Set time to 00:00:00 for accurate date comparison
                            carrierDateObj.setHours(0, 0, 0, 0);
                            receivedDateObj.setHours(0, 0, 0, 0);
                            
                            if (receivedDateObj < carrierDateObj) {
                                alert('Received date must be after or equal to carrier date.');
                                $(this).val('');
                                return false;
                            }
                        }
                    });
                }, 100);
            });
        </script>

    </body>
</html>
<?php
  } else {
    echo '<script> window.location.href = "../../login.php"; </script>';
  }
?>

process.php
<?php
include_once("../../database/connection.php");

class Process extends Database
{
    public function Initialize(){
        $isynBranch = $this->SelectQuery("SELECT DISTINCT Stock FROM tbl_invlist ORDER BY Stock");
        $branch = $this->SelectQuery("SELECT DISTINCT ItemName FROM tbl_maintenance WHERE ItemType='BRANCH'");
        $prodType = $this->SelectQuery("SELECT DISTINCT Type FROM tbl_prodtype ORDER BY Type");
        $customertype = $this->SelectQuery("SELECT DISTINCT Type FROM tbl_clientlist ORDER BY Type");
        $transmittno = 0000;
        $orgname = "Set organization name in system data.";

        $stmt = $this->conn->prepare("SELECT Value FROM tbl_configuration WHERE ConfigOwner='TRANSMITTALRECEIPT' AND ConfigName='CURRENTTRANSMITTALNO'");
        $stmt->execute();
        $result = $stmt->get_result();
        $stmt->close();
        if ($result->num_rows > 0) {
            $row = $result->fetch_assoc();
            $transmittno = $row['Value'];
        }

        $morno = "";
        $zeroes = 7 - strlen($transmittno);
        for ($i=0; $i < $zeroes; $i++) { 
            $morno = "0".$morno;
        }
        
        $currUser = $_SESSION['USERNAME'];
        $FL = substr($currUser, 0, 1);
        $LL = substr($currUser, -1, 1);

        $transmittno = "TM". $FL . "" . $LL . "" . $morno . "" . $transmittno;

        $stmt = $this->conn->prepare("SELECT Value FROM tbl_configuration WHERE ConfigOwner='TRANSMITTALRECEIPT' AND ConfigName='ORGNAME'");
        $stmt->execute();
        $result = $stmt->get_result();
        $stmt->close();
        if ($result->num_rows > 0) {
            $row = $result->fetch_assoc();
            $orgname = $row['Value'];
        }

        $stmtClear = $this->conn->prepare("DELETE FROM tbl_transaction");
        $stmtClear->execute();

        echo json_encode(array( 
            "ISYNBRANCH" => $isynBranch,
            "PRODTYPE" => $prodType,
            "CUSTOMERTYPE" => $customertype,
            "TRANSMITNO" => $transmittno,
            "ORGNAME" => $orgname,
        ));
    }
    
    public function LoadBranch($data){
        $branch = [];
        $value = $data['value'];
        $stmt = $this->conn->prepare("SELECT DISTINCT Stock FROM tbl_invlistconsign WHERE Branch = ? ORDER BY Stock;");
        $stmt->bind_param('s', $value);
        $stmt->execute();
        $result = $stmt->get_result();
        if ($result->num_rows > 0) {
            while ($row = $result->fetch_assoc()) {
                $branch[] = $row;
            }
        }

        echo json_encode(array( 
            "BRANCH" => $branch,
        ));
    }

    public function LoadCategory($data){
        $categ = [];
        $isConsign = $data['isConsign'];
        $type = $data['type'];
        $isynBranch = $data['isynBranch'];
        $consignBranch = $data['consignBranch'];

        if ($isConsign === "Yes"){
            $stmt = $this->conn->prepare("SELECT DISTINCT Category FROM tbl_invlistconsign WHERE Type = ? AND Stock = ? AND Branch = ? ORDER BY Category");
            $stmt->bind_param('sss', $type, $consignBranch, $isynBranch);
            $stmt->execute();
            $result = $stmt->get_result();
            if ($result->num_rows > 0) {
                while ($row = $result->fetch_assoc()) {
                    $categ[] = $row;
                }
            }
        } else {
            $stmt = $this->conn->prepare("SELECT DISTINCT Category FROM tbl_invlist WHERE Type = ? AND Branch = ? ORDER BY Category");
            $stmt->bind_param('ss', $type, $isynBranch);
            $stmt->execute();
            $result = $stmt->get_result();
            if ($result->num_rows > 0) {
                while ($row = $result->fetch_assoc()) {
                    $categ[] = $row;
                }
            }
        }

        echo json_encode(array( 
            "CATEG" => $categ,
        ));
    }

    public function LoadSerialProduct($data){
        $serialproduct = [];
        $productSINo = [];
        $isConsign = $data['isConsign'];
        $type = $data['type'];
        $category = $data['category'];
        $isynBranch = $data['isynBranch'];
        $consignBranch = $data['consignBranch'];

        if ($isConsign === "Yes"){
            $stmt = $this->conn->prepare("SELECT SIno, Serialno, Product FROM tbl_invlistconsign WHERE Category = ? AND Type = ? AND Stock = ? AND Branch = ?");
            $stmt->bind_param('ssss', $category, $type, $consignBranch, $isynBranch);
            $stmt->execute();
            $result = $stmt->get_result();
            if ($result->num_rows > 0) {
                while ($row = $result->fetch_assoc()) {
                    $serialproduct[] = $row;
                }
            }

            $stmt2 = $this->conn->prepare("SELECT DISTINCT SIno FROM tbl_invlistconsign WHERE Category = ? AND Type = ? AND Stock = ? AND Branch = ?");
            $stmt2->bind_param('ssss', $category, $type, $consignBranch, $isynBranch);
            $stmt2->execute();
            $result2 = $stmt2->get_result();
            if ($result2->num_rows > 0) {
                while ($row = $result2->fetch_assoc()) {
                    $productSINo[] = $row;
                }
            }
        } else {
            $stmt = $this->conn->prepare("SELECT SIno, Serialno, Product FROM tbl_invlist WHERE Category = ? AND Type = ? AND Branch = ?");
            $stmt->bind_param('sss', $category, $type, $isynBranch);
            $stmt->execute();
            $result = $stmt->get_result();
            if ($result->num_rows > 0) {
                while ($row = $result->fetch_assoc()) {
                    $serialproduct[] = $row;
                }
            }

            $stmt2 = $this->conn->prepare("SELECT DISTINCT SIno FROM tbl_invlist WHERE Category = ? AND Type = ? AND Branch = ?");
            $stmt2->bind_param('sss', $category, $type, $isynBranch);
            $stmt2->execute();
            $result2 = $stmt2->get_result();
            if ($result2->num_rows > 0) {
                while ($row = $result2->fetch_assoc()) {
                    $productSINo[] = $row;
                }
            }
        }

        echo json_encode(array( 
            "SRKPRDT" => $serialproduct,
            "PRDTSINO" => $productSINo,
        ));
    }

    public function LoadProductSummary($data){
        $branch = $data["isConsign"] == "No" ? $data["isynBranch"] : $data["consignBranch"];
        $table = $data["isConsign"] == "No" ? "tbl_invlist" : "tbl_invlistconsign";
        $selectBy = $data["selectBy"];
        $type = $data["type"];
        $category = $data["category"];
        $serialProduct = $data["serialProduct"];
        $SINo = $data["SINo"];
        // $isynBranch = $data["isynBranch"];
        // $consignBranch = $data["consignBranch"];
        $productSummary = "";

        if ($selectBy == "serial"){
            $stmt = $this->conn->prepare("SELECT * FROM ".$table." WHERE Type = ? AND Category = ? AND SIno = ? AND stock = ? AND Serialno = ?");
            $stmt->bind_param('sssss', $type, $category, $SINo, $branch, $serialProduct);
            $stmt->execute();
            $result = $stmt->get_result();
            if ($result->num_rows > 0) {
                $row = $result->fetch_assoc();
                $productSummary = $row;
            }
        } else {
            $stmt = $this->conn->prepare("SELECT * FROM ".$table." WHERE Type = ? AND Category = ? AND SIno = ? AND stock = ? AND Product = ?");
            $stmt->bind_param('sssss', $type, $category, $SINo, $branch, $serialProduct);
            $stmt->execute();
            $result = $stmt->get_result();
            if ($result->num_rows > 0) {
                $row = $result->fetch_assoc();
                $productSummary = $row;
            }

        }

        echo json_encode(array(
            "PSUMMARY" => $productSummary,
        ));
    }

    // ===================================================================================

    public function TransmittalSearch($data){
        $transactlist = [];

        $dateFrom = $data['dateFrom'];
        $dateTo = $data['dateTo'];        

        $stmt = $this->conn->prepare("SELECT DISTINCT TransmittalNO, NameTO, DatePrepared, isOUT, SalesInvoice FROM tbl_transmittal WHERE STR_TO_DATE(DatePrepared,'%m/%d/%Y') >= STR_TO_DATE(?,'%m/%d/%Y') AND STR_TO_DATE(DatePrepared,'%m/%d/%Y') <= STR_TO_DATE(?,'%m/%d/%Y') ORDER BY TransmittalNO, str_to_date(DatePrepared,'%m/%d/%Y') DESC");
        $stmt->bind_param('ss', $dateFrom, $dateTo);
        $stmt->execute();
        $result = $stmt->get_result();
        if ($result->num_rows > 0) {
            while ($row = $result->fetch_assoc()) {
                $transactlist[] = $row;
            }
        }

        echo json_encode(array( 
            "TRANSACTIONLIST" => $transactlist,
        ));
    }

    public function SubmitInvOut($data){
        try {
            $this->conn->autocommit(false);

            $entries = json_decode($data["DATA"]);
            $values = "";

            $TotalAmount = 0;

            for ($i=0; $i < count($entries); $i++) {
                $TotalAmount .= $entries[$i][2];
            }


            $stmt = $this->conn->prepare("INSERT INTO tbl_transmittal (TransmittalNO, NameTO, NameFROM, InOrder, Quantity, ProductSerialNo, Amount, Remarks, Carrier, DateCarrier, ReceivedBy, DateReceived, totalAmount, DatePrepared, SIno, SerialNo, Product, Supplier, Category, Type, Branch, Consignment, Stock) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)");
            // $stmt->bind_param('sssssssssssssssssssssss', $);
            $stmt->execute();


            date_default_timezone_set('Asia/Manila');
            $AsOf = date("m/d/Y", strtotime("now"));

            $user = $_SESSION['USERNAME'];
            $SalesInvoice = "";
            $stmt = $this->conn->prepare("SELECT SIcount FROM TBL_SINUMBER WHERE user = ?");
            $stmt->bind_param('s', $user);
            $stmt->execute();
            $result = $stmt->get_result();
            if ($result->num_rows > 0) {
                $row = $result->fetch_assoc();
                $SalesInvoice = $row['SIcount'];
            }
            $stmt->close();

            $NewSalesInvoice = $SalesInvoice + 1;
    
            $stmt1 = $this->conn->prepare("UPDATE tbl_transaction SET SI = ? WHERE User = ?");
            $stmt1->bind_param('ss', $SalesInvoice,$user);
            $stmt1->execute();
            $stmt1->close();
            
            $stmt2 = $this->conn->prepare("UPDATE tbl_sinumber SET SIcount = ? WHERE User = ?");
            $stmt2->bind_param('ss', $NewSalesInvoice,$user);
            $stmt2->execute();
            $stmt2->close();

            $currentQuantity = 0;
            $DealerPrice = 0;
            $ProdSRP = 0;

            $Totalprice = 0;
            $TSRP = 0;
            $MyMark = 0;
            $MyTMark = 0;

            $MyVat = 0;
            $MySalesVat = 0;

            $SerialNo = "";
            $SI = "";
            $ProductName = "";
            $MyQuantity = "";
            $TotalSales = 0;
            $MyCategory = "";
            $ItemConsign = "";
            $isynBranch = "";
            $askiBranch = "";
            $Type = "";

            $SalesNoVat = 0;
            $SalesWithVat = 0;
            $AmountDue = 0;
            $VAT = 0.12;

            $SIRef = "-";
            $DateAdded = "-";

            $stmt3 = $this->conn->prepare("SELECT * FROM tbl_transaction WHERE User = ?");
            $stmt3->bind_param('s', $user);
            $stmt3->execute();
            $result3 = $stmt3->get_result();
            if ($result3->num_rows > 0) {
                while ($row3 = $result3->fetch_assoc()) {
                    $SerialNo = $row3['Serialno'];
                    $SI = $row3['SupplierSI'];
                    $ProductName = $row3['Product'];
                    $MyQuantity = $row3['Quantity'];
                    $Type = $row3['Type'];

                    if ($row3['DiscProduct'] == "Yes") {
                        $TotalSales = $row3['DiscNewTotalSRP'];
                    } else {
                        $TotalSales = $row3['TotalSRP'];
                    }
                    
                    $MyCategory = $row3['Category'];
                    $ItemConsign = $row3['itemConsign']  ;
                    $isynBranch = $row3['Branch'];
                    $askiBranch = $row3['Stock'];

                    if ($ItemConsign == "CONSIGNMENT") {
                        $stmt4 = $this->conn->prepare("SELECT * FROM tbl_invlistconsign WHERE SINO = ? AND SERIALNO = ? AND PRODUCT = ? AND CATEGORY = ? AND STOCK = ? AND BRANCH = ?");
                        $stmt4->bind_param('ssssss', $SI, $SerialNo, $ProductName, $MyCategory, $askiBranch, $isynBranch);
                        $stmt4->execute();
                        $result4 = $stmt4->get_result();
                        if ($result4->num_rows > 0) {
                            $row4 = $result4->fetch_assoc();
                            $currentQuantity = $row4["Quantity"];
                            $DealerPrice = $row4["DealerPrice"];
                            $ProdSRP = $row4["SRP"];

                            $rcQuantity = $currentQuantity - $MyQuantity;

                            if ($rcQuantity == 0){
                                $stmt = $this->conn->prepare("INSERT INTO tbl_invlistconsignhistory SELECT * FROM tbl_invlistconsign WHERE SERIALNO = ? AND SINO = ? AND PRODUCT = ? AND CATEGORY = ? AND STOCK = ? AND BRANCH = ?");
                                $stmt->bind_param('ssssss', $SerialNo,$SI,$ProductName,$MyCategory,$askiBranch,$isynBranch);
                                $stmt->execute();
                                $stmt->close();

                                $stmt = $this->conn->prepare("DELETE FROM tbl_invlistconsign WHERE SERIALNO = ? AND SINO = ? AND PRODUCT = ? AND CATEGORY = ? AND STOCK = ? AND BRANCH = ?");
                                $stmt->bind_param('ssssss', $SerialNo,$SI,$ProductName,$MyCategory,$askiBranch,$isynBranch);
                                $stmt->execute();
                                $stmt->close();
                            } else {

                                $Totalprice = floatval($DealerPrice * $rcQuantity);
                                $TSRP = floatval($ProdSRP * $rcQuantity);
                                $MyMark = floatval($ProdSRP * $rcQuantity);
                                $MyTMark = round($MyMark - $Totalprice, 2);

                                if ($Type == "WITH VAT") {
                                    $MyVat = round(((floatval($DealerPrice) / 1.12) * 0.12), 2) * floatval($rcQuantity);
                                    $MySalesVat = floatval($Totalprice) - $MyVat;
                                } else {
                                    $MyVat = 0;
                                    $MySalesVat = $Totalprice;
                                }

                                $stmt = $this->conn->prepare("UPDATE tbl_invlistconsign SET QUANTITY = ?, TOTALPRICE = ?, TOTALSRP =?, TOTALMARKUP = ?, VATSALES = ?, VAT = ?, AMOUNTDUE = ? WHERE SERIALNO = ? AND SINO = ? AND PRODUCT = ? AND CATEGORY = ? AND STOCK = ? AND BRANCH = ?");
                                $stmt->bind_param('sssssssssssss', $rcQuantity,$Totalprice,$TSRP,$MyTMark,$MySalesVat,$MyVat,$Totalprice,$SerialNo,$SI,$ProductName,$MyCategory,$askiBranch,$isynBranch);
                                $stmt->execute();
                                $stmt->close();
                            }                            
                        }
                        $stmt4->close();

                        // ==================
                        $stmt5 = $this->conn->prepare("SELECT * FROM tbl_invlist WHERE SINO = ? AND SERIALNO = ? AND PRODUCT = ? AND CATEGORY = ? AND BRANCH = ?");
                        $stmt5->bind_param('sssss', $SI, $SerialNo, $ProductName, $MyCategory, $isynBranch);
                        $stmt5->execute();
                        $result5 = $stmt5->get_result();
                        if ($result5->num_rows > 0) {
                            $row5 = $result5->fetch_assoc();
                            $currentQuantity = $row5["Quantity"];
                            $DealerPrice = $row5["DealerPrice"];
                            $ProdSRP = $row5["SRP"];

                            $rcQuantity = $currentQuantity - $MyQuantity;

                            if ($rcQuantity == 0){
                                $stmt = $this->conn->prepare("INSERT INTO tbl_prodhistory SELECT * FROM tbl_invlistconsign WHERE SERIALNO = ? AND SINO = ? AND PRODUCT = ? AND CATEGORY = ? AND BRANCH = ?");
                                $stmt->bind_param('sssss', $SerialNo,$SI,$ProductName,$MyCategory,$isynBranch);
                                $stmt->execute();
                                $stmt->close();

                                $stmt = $this->conn->prepare("DELETE FROM tbl_invlist WHERE SERIALNO = ? AND SINO = ? AND PRODUCT = ? AND CATEGORY = ? AND BRANCH = ?");
                                $stmt->bind_param('sssss', $SerialNo,$SI,$ProductName,$MyCategory,$isynBranch);
                                $stmt->execute();
                                $stmt->close();
                            } else {
                                $Totalprice = floatval($DealerPrice * $rcQuantity);
                                $TSRP = floatval($ProdSRP * $rcQuantity);
                                $MyMark = floatval($ProdSRP * $rcQuantity);
                                $MyTMark = round($MyMark - $Totalprice, 2);

                                if ($Type == "WITH VAT") {
                                    $MyVat = round(((floatval($DealerPrice) / 1.12) * 0.12), 2) * floatval($rcQuantity);
                                    $MySalesVat = floatval($Totalprice) - $MyVat;
                                } else {
                                    $MyVat = 0;
                                    $MySalesVat = $Totalprice;
                                }

                                $stmt = $this->conn->prepare("UPDATE tbl_invlist SET QUANTITY = ?, TOTALPRICE = ?, TOTALSRP =?, TOTALMARKUP = ?, VATSALES = ?, VAT = ?, AMOUNTDUE = ? WHERE SERIALNO = ? AND SINO = ? AND PRODUCT = ? AND CATEGORY = ? AND BRANCH = ?");
                                $stmt->bind_param('ssssssssssss', $rcQuantity,$Totalprice,$TSRP,$MyTMark,$MySalesVat,$MyVat,$Totalprice,$SerialNo,$SI,$ProductName,$MyCategory,$isynBranch);
                                $stmt->execute();
                                $stmt->close();
                            }                            
                        }
                        $stmt5->close();
                    } else {
                        $stmt6 = $this->conn->prepare("SELECT * FROM tbl_invlist WHERE SINO = ? AND SERIALNO = ? AND PRODUCT = ? AND CATEGORY = ? AND BRANCH = ?");
                        $stmt6->bind_param('sssss', $SI, $SerialNo, $ProductName, $MyCategory, $isynBranch);
                        $stmt6->execute();
                        $result6 = $stmt6->get_result();
                        if ($result6->num_rows > 0) {
                            $row6 = $result6->fetch_assoc();
                            $currentQuantity = $row6["Quantity"];
                            $DealerPrice = $row6["DealerPrice"];
                            $ProdSRP = $row6["SRP"];

                            $rcQuantity = $currentQuantity - $MyQuantity;

                            if ($rcQuantity == 0){
                                $stmt = $this->conn->prepare("INSERT INTO tbl_prodhistory SELECT * FROM tbl_invlist WHERE SERIALNO = ? AND SINO = ? AND PRODUCT = ? AND CATEGORY = ? AND BRANCH = ?");
                                $stmt->bind_param('sssss', $SerialNo,$SI,$ProductName,$MyCategory,$isynBranch);
                                $stmt->execute();
                                $stmt->close();

                                $stmt = $this->conn->prepare("DELETE FROM tbl_invlist WHERE SERIALNO = ? AND SINO = ? AND PRODUCT = ? AND CATEGORY = ? AND BRANCH = ?");
                                $stmt->bind_param('sssss', $SerialNo,$SI,$ProductName,$MyCategory,$isynBranch);
                                $stmt->execute();
                                $stmt->close();
                            } else {
                                $Totalprice = floatval($DealerPrice * $rcQuantity);
                                $TSRP = floatval($ProdSRP * $rcQuantity);
                                $MyMark = floatval($ProdSRP * $rcQuantity);
                                $MyTMark = round($MyMark - $Totalprice, 2);

                                if ($Type == "WITH VAT") {
                                    $MyVat = round(((floatval($DealerPrice) / 1.12) * 0.12), 2) * floatval($rcQuantity);
                                    $MySalesVat = floatval($Totalprice) - $MyVat;
                                } else {
                                    $MyVat = 0;
                                    $MySalesVat = $Totalprice;
                                }

                                $stmt = $this->conn->prepare("UPDATE tbl_invlist SET QUANTITY = ?, TOTALPRICE = ?, TOTALSRP =?, TOTALMARKUP = ?, VATSALES = ?, VAT = ?, AMOUNTDUE = ? WHERE SERIALNO = ? AND SINO = ? AND PRODUCT = ? AND CATEGORY = ? AND BRANCH = ?");
                                $stmt->bind_param('ssssssssssss', $rcQuantity,$Totalprice,$TSRP,$MyTMark,$MySalesVat,$MyVat,$Totalprice,$SerialNo,$SI,$ProductName,$MyCategory,$isynBranch);
                                $stmt->execute();
                                $stmt->close();
                            }
                        }
                        $stmt6->close();
                    }

                    $SalesNoVat += $TotalSales / 1.12;
                    $SalesWithVat = round($SalesNoVat * $VAT, 2);
                    $AmountDue = round($SalesNoVat + $SalesWithVat, 2);
                }

                $stmt7 = $this->conn->prepare("SELECT DateAdded, SI, Soldto, SUM(AmountDue) as forTotal, SUM(VatSAles) as forSales, SUM(VAT) as forVAT, TIN, Address, Status, Branch FROM tbl_transaction GROUP BY SI, User, Branch;");
                $stmt7->execute();
                $result7 = $stmt7->get_result();
                if ($result7->num_rows > 0) {
                    while ($row7 = $result7->fetch_assoc()) {
                        $SIRef = $row7['SI'];
                        $DateAdded = $row7['DateAdded'];
                        $Total = $row7['forTotal'];
                        $SoldTo = $row7['Soldto'];
                        $Tin = $row7['TIN'];
                        $Address = $row7['Address'];
                        $isynBranch = $row7['Branch'];

                        $sSales = round(floatval($Total) / 1.12, 2);
                        $sVAT = round((floatval($Total) / 1.12) * 0.12, 2);

                        $stmt = $this->conn->prepare("INSERT INTO tbl_salesjournal (DateSold,Reference,Customer,GrossSales,VAT,NetSales,TIN,Address,Stock) VALUES (?,?,?,?,?,?,?,?,?)");
                        $stmt->bind_param('sssssssss', $DateAdded,$SIRef,$SoldTo,$Total,$sVAT,$sSales,$Tin,$Address,$isynBranch);
                        $stmt->execute();
                        $stmt->close();
                    }

                    $stmt = $this->conn->prepare("UPDATE tbl_transaction SET VatSales = TotalPrice, VAT = 0, AmountDue = TotalPrice WHERE Type = 'NON-VAT' AND User = ?");
                    $stmt->bind_param('s', $user);
                    $stmt->execute();
                    $stmt->close();

                    $stmt = $this->conn->prepare("UPDATE tbl_transaction SET VatSales = ((DealerPrice * Quantity)-(round(((DealerPrice/1.12)*0.12),2) * Quantity)),VAT = (round(((DealerPrice/1.12)*0.12),2) * Quantity), AmountDue=TotalPrice WHERE Type = 'WITH VAT' AND User = ?");
                    $stmt->bind_param('s', $user);
                    $stmt->execute();
                    $stmt->close();

                    $stmt = $this->conn->prepare("INSERT INTO tbl_inventoryout (SI, SupplierSI, Batchno, Serialno, Product, Supplier, Category, Type, Quantity, DealerPrice, TotalPrice, SRP, TotalSRP, Markup, TotalMarkup, VatSales, VAT, AmountDue, DateAdded, User, Soldto, TIN, Address, Status, Stock, Branch, itemConsign, myClient, Area, Department, DiscProduct, DiscInterest, DiscAmount, DiscNewSRP, DiscNewTotalSRP, Warranty, imgname) SELECT SI, SupplierSI, Batchno, Serialno, Product, Supplier, Category, Type, Quantity, DealerPrice, TotalPrice, SRP, TotalSRP, Markup, TotalMarkup, VatSales, VAT, AmountDue, DateAdded, User, Soldto, TIN, Address, Status, Stock, Branch, itemConsign, myClient, Area, Department, DiscProduct, DiscInterest, DiscAmount, DiscNewSRP, DiscNewTotalSRP, Warranty, imgname FROM tbl_transaction WHERE User = ?");
                    $stmt->bind_param('s', $user);
                    $stmt->execute();
                    $stmt->close();

                    $stmt = $this->conn->prepare("DELETE FROM tbl_transaction WHERE User = ?");
                    $stmt->bind_param('s', $user);
                    $stmt->execute();
                    $stmt->close();
                }
                $stmt7->close();
            }
            $stmt3->close();
            
            $status = "success";
            $message = "Product details were saved successfully.";

            $tableData = json_decode($data['DATA']);
            unset($_SESSION['tableData']);
            unset($_SESSION['SalesNoVAT']);
            unset($_SESSION['SalesWithVAT']);
            unset($_SESSION['SIRef']);
            unset($_SESSION['DateAdded']);
            $_SESSION['tableData'] = $tableData;
            $_SESSION['SalesNoVAT'] = $SalesNoVat;
            $_SESSION['SalesWithVAT'] = $SalesWithVat;
            $_SESSION['SIRef'] = $SIRef;
            $_SESSION['DateAdded'] = $DateAdded;

            $this->conn->commit();
            
            echo json_encode(array(
                "STATUS" => $status,
                "MESSAGE" => $message,
                // "NOVAT" => $SalesNoVat,
                // "YESVAT" => $SalesWithVat,
                // "TTLSLS" => $TotalSales,
                "SRLNO" => $SerialNo,
                "SI" => $SI,
                "PN" => $ProductName,
                "MYCAT" => $MyCategory,
                "ISYNBRANCH" => $isynBranch,
            ));
            $this->conn->autocommit(true);
        } catch (Exception $e) {
            $this->conn->rollback();
            echo json_encode(array(
                "STATUS" => "ERROR",
                "MESSAGE" => $e->getMessage()
            ));
        }
    }

    public function PrintSalesInvoice ($data) {
        $products = [];
        date_default_timezone_set('Asia/Manila');
        $AsOf = date("m/d/Y", strtotime("now"));
        $ProdPend = "NO";

        $stmt = $this->conn->prepare("SELECT Quantity, DateAdded, SIno, Supplier, SUM(TotalPrice) AS forTotal, SUM(Vat) AS forVAT, SUM(VatSales) AS forSVat, Stock, Branch, User FROM tbl_inventoryin WHERE ProdPend = 'YES' AND STR_TO_DATE(AsOf, '%m/%d/%Y') = STR_TO_DATE(?, '%m/%d/%Y') GROUP BY SIno, Supplier, Stock, Branch, DateAdded, User");
        $stmt->bind_param('s', $AsOf);
        $stmt->execute();
        $result = $stmt->get_result();
        if ($result->num_rows > 0) {
            while ($row = $result->fetch_assoc()) {
                $products[] = $row;

                $purchaseDate = $row['DateAdded'];
                $SINo = $row['SIno'];
                $supplier = $row['Supplier'];
                $total = $row['forTotal'];
                $vat = $row['forVAT'];
                $svat = $row['forSVat'];
                $stock = $row['Stock'];
                $branch = $row['Branch'];

                $stmt1 = $this->conn->prepare("INSERT INTO tbl_purchasejournal (DatePurchase, Reference, Supplier, GrossPurchase, InputVAT, NetPurchase, Stock, Branch) VALUES (?,?,?,?,?,?,?,?,?)");
                $stmt1->bind_param('ssssssss', $purchaseDate, $SINo, $supplier, $total, $vat, $svat, $stock, $branch);
                $stmt1->execute();

                $stmt2 = $this->conn->prepare("SELECT tinNumber, fullAddress FROM tbl_supplier_info WHERE supplierName = ?");
                $stmt2->bind_param('s', $supplier);
                $stmt2->execute();
                $result2 = $stmt2->get_result();
                if ($result2->num_rows > 0) {
                    $row2 = $result2->fetch_assoc();
                    $tin = $row2['tinNumber'];
                    $address = $row2['fullAddress'];
                    
                    $stmt3 = $this->conn->prepare("UPDATE tbl_purchasejournal SET TIN = ?,  Address = ? WHERE Supplier = ? AND TIN = '-' AND Address = '-'");
                    $stmt3->bind_param('sss', $tin, $address, $supplier);
                    $stmt3->execute();
                }
            }
        }

        $stmt3 = $this->conn->prepare("INSERT INTO tbl_invlist (SIno, Serialno, Product, Supplier, Category, Type, Quantity, DealerPrice, TotalPrice, SRP, TotalSRP, Markup, TotalMarkup, VatSales, Vat, AmountDue, DateAdded, DatePurchase, User, AsOf, ProdPend, Stock, Branch, Warranty, imgname) SELECT SIno, Serialno, Product, Supplier, Category, Type, Quantity, DealerPrice, TotalPrice, SRP, TotalSRP, Markup, TotalMarkup, VatSales, Vat, AmountDue, DateAdded, DatePurchase, User, AsOf, ?, Stock, Branch, Warranty, imgname FROM tbl_inventoryin WHERE ProdPend = 'YES' AND STR_TO_DATE(AsOf, '%m/%d/%Y') = STR_TO_DATE(?, '%m/%d/%Y')");
        $stmt3->bind_param('ss', $ProdPend, $AsOf);
        $stmt3->execute();

        $stmt3 = $this->conn->prepare("UPDATE tbl_inventoryin SET ProdPend = 'NO' WHERE ProdPend = 'YES'");
        $stmt3->execute();

        $tableData = json_decode($data['DATA']);
        unset($_SESSION['tableData']);
        $_SESSION['tableData'] = $tableData;

        echo json_encode(array(
            "PRODS" => $products,
            "DATAINVSESS" => $tableData,
        ));
    }

    private function SelectQuery($string){
        $data = [];
        $stmt = $this->conn->prepare($string);
        $stmt->execute();
        $result = $stmt->get_result();
        $stmt->close();
        while ($row = $result->fetch_assoc()) {
            $data[] = $row;
        }
        return $data;
    }
}



route.php
<?php
include_once("../../process/inventorymanagement/transmittalreceipt.process.php");
include_once("../../reports/inventorymanagement/transmittalreceipt.reports.php");

$process = new Process();
$report = new Reports();

if(isset($_POST['action']) AND $_POST['action'] == 'Initialize'){
    $process->Initialize();
}

if(isset($_POST['action']) AND $_POST['action'] == 'LoadBranch'){
    $process->LoadBranch($_POST);
}

if(isset($_POST['action']) AND $_POST['action'] == 'LoadCategory'){
    $process->LoadCategory($_POST);
}

if(isset($_POST['action']) AND $_POST['action'] == 'LoadSerialProduct'){
    $process->LoadSerialProduct($_POST);
}

if(isset($_POST['action']) AND $_POST['action'] == 'LoadProductSummary'){
    $process->LoadProductSummary($_POST);
}

if(isset($_POST['action']) AND $_POST['action'] == 'LoadCustomerName'){
    $process->LoadCustomerName($_POST);
}

if(isset($_POST['action']) AND $_POST['action'] == 'LoadCustomerNameInfo'){
    $process->LoadCustomerNameInfo($_POST);
}

if(isset($_POST['action']) AND $_POST['action'] == 'AddToItems'){
    $process->AddToItems($_POST);
}

if(isset($_POST['action']) AND $_POST['action'] == 'UseQtyFromBranchConsign'){
    $process->UseQtyFromBranchConsign($_POST);
}

// ======================================================================
if(isset($_POST['action']) AND $_POST['action'] == 'LoadTransaction'){
    $process->LoadTransaction();
}

if(isset($_POST['action']) AND $_POST['action'] == 'DeleteFromItems'){
    $process->DeleteFromItems($_POST);
}

if(isset($_POST['action']) AND $_POST['action'] == 'TransmittalSearch'){
    $process->TransmittalSearch($_POST);
}

if(isset($_POST['action']) AND $_POST['action'] == 'fetchProducts'){
    $process->fetchProducts($_POST);
}

if(isset($_POST['action']) AND $_POST['action'] == 'LoadtoList'){
    $process->LoadtoList($_POST);
}

if(isset($_POST['action']) AND $_POST['action'] == 'SubmitInvOut'){
    $process->SubmitInvOut($_POST);
}

if(isset($_GET["type"]) && $_GET["type"] == 'PrintSalesInvoice'){
    $report->PrintOutgoingSalesInvoice($_SESSION['tableData'],$_SESSION['SalesNoVAT'],$_SESSION['SalesWithVAT'], $_SESSION['SIRef'],$_SESSION['DateAdded']);
}

if(isset($_GET["type"]) && $_GET["type"] == 'RePrintTransmittal'){
    $transNo = $_GET['transNo'] ?? '';
    $report->PrintTransmittalReceipt($transNo);
}


report.php
<?php
require_once('../../assets/tcpdf/tcpdf.php');

class Reports extends Database 
{
    public function PrintOutgoingSalesInvoice($tableData,$SalesNoVAT,$SalesWithVAT,$SIRef,$DateAdded){
        ob_clean();
		ob_flush();

        ini_set('memory_limit','-1');
        set_time_limit(0);
        
		$pdf = new TCPDF('P', PDF_UNIT, 'A5', true, 'UTF-8', false);
		$pdf->SetCreator(PDF_CREATOR);
		$pdf->SetAuthor('isynergiesinc');
		$pdf->SetTitle('SUPPLIER\'S RECEIPT');
        $pdf->SetPrintHeader(false);
        $pdf->SetPrintFooter(false);
		$pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);
		$pdf->SetMargins(4, 8, 4);
		$pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
		$pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);
		if (@file_exists(dirname(__FILE__).'/lang/eng.php')) {
		    require_once(dirname(__FILE__).'/lang/eng.php');
		    $pdf->setLanguageArray($l);
		}
		$pdf->SetFont('helvetica', '', 10);
        $pdf->AddPage();

        $contentdata = '';

        $datesold = "-";
        $soldto = "-";
        $tin = "-";
        $address = "-";
        $totalAmountDue = 0;

        $stmt = $this->conn->prepare("SELECT * FROM tbl_salesjournal WHERE STR_TO_DATE(DateSold,'%m/%d/%Y') = STR_TO_DATE(?,'%m/%d/%Y') AND Reference = ?");
        $stmt->bind_param("ss",$DateAdded,$SIRef);
        $stmt->execute();
        $result = $stmt->get_result();
        $stmt->close();
        
        if ($result->num_rows > 0) {
            $row = $result->fetch_assoc();
            $datesold = $row["DateSold"];
            $soldto = $row["Customer"];
            $tin = $row["TIN"];
            $address = $row["Address"];
        }

        $rowsqty = "8";

        foreach ($tableData as $row){
            $rowsqty--;
            $contentdata .= '
                    <tr style="font-size:6pt;">
                        <td style="text-align:center;">'.$row[4].'</td>
                        <td style="text-align:center;">'.$row[5].'</td>
                        <td style="">'.$row[6].'</td>
                        <td style="text-align:right;">'.number_format(str_replace(",","",$row[7]),2).'</td>
                        <td style="text-align:right;">'.number_format(str_replace(",","",$row[8]),2).'</td>
                    </tr>
            ';

            $totalAmountDue = floatval($totalAmountDue) + floatval(str_replace(",","",$row[8]));
        }

        for ($i = 0; $i < $rowsqty; $i++) {
            $contentdata .= '
                    <tr style="font-size:6pt;">
                        <td style="text-align:center;"></td>
                        <td style="text-align:center;"></td>
                        <td style=""></td>
                        <td style="text-align:right;"></td>
                        <td style="text-align:right;"></td>
                    </tr>
            ';
        }
        
        $content = '';

        $content .= '<table border="0">
                        <tr>
                            <td width="100%" style="line-height:100px;"></td>
                        </tr>
                        <tr>
                            <td width="70%" style="font-size:7px;"><table border="0">
                                    <tr>
                                        <td width="10%" style="font-weight:bold;">SOLD to </td>
                                        <td width="90%">'.$soldto.'</td>
                                    </tr>
                                </table>
                            </td>
                            <td width="30%" style="font-size:7px;"><table border="0">
                                    <tr>
                                        <td width="15%" style="font-weight:bold;">Date </td>
                                        <td width="85%">'.$datesold.'</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td width="100%" style="font-size:7px;"><table border="0">
                                    <tr>
                                        <td width="7%" style="font-weight:bold;">TIN </td>
                                        <td width="93%">'.$tin.'</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td width="100%" style="font-size:7px;"><table border="0">
                                    <tr>
                                        <td width="7%" style="font-weight:bold;">Address </td>
                                        <td width="93%">'.$address.'</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr><td width="100%"></td></tr>
                        <tr><td width="100%"></td></tr>
                        <tr style="font-weight:bold;font-size:6pt;text-align:center;">
                            <td width="10%">QUANTITY</td>
                            <td width="5%">UNIT</td>
                            <td width="65%">ARTICLES</td>
                            <td width="10%">UNIT PRICE</td>
                            <td width="10%">AMOUNT</td>
                        </tr>
                        '.$contentdata.'
                        <tr style="font-size:6pt;">
                            <td width="10%"></td>
                            <td width="5%"></td>
                            <td width="10%">VATable Sales</td>
                            <td width="55%">'.$SalesNoVAT.'</td>
                            <td width="10%"></td>
                            <td width="10%"></td>
                        </tr>
                        <tr style="font-size:6pt;">
                            <td width="10%"></td>
                            <td width="5%"></td>
                            <td width="10%"></td>
                            <td width="55%"></td>
                            <td width="10%"></td>
                            <td width="10%"></td>
                        </tr>
                        <tr style="font-size:6pt;">
                            <td width="10%"></td>
                            <td width="5%"></td>
                            <td width="10%"></td>
                            <td width="55%"></td>
                            <td width="10%"></td>
                            <td width="10%"></td>
                        </tr>
                        <tr style="font-size:6pt;">
                            <td width="10%"></td>
                            <td width="5%"></td>
                            <td width="10%">VAT Amount</td>
                            <td width="55%">'.$SalesWithVAT.'</td>
                            <td width="10%"></td>
                            <td width="10%"></td>
                        </tr>
                        <tr style="font-size:6pt;text-align:right;">
                            <td width="90%"></td>
                            <td width="10%">'.number_format($totalAmountDue,2).'</td>
                        </tr>
                    </table>
        ';

        // logs($_SESSION['usertype'], "Printed JV Report", "btnJVPrint", $_SESSION['username'], "JV Reports");        
        
        $pdf->writeHTML($content, true, 0, true, 0);
		$pdf->lastPage();
        $pdf->IncludeJS("print();");
		$pdf->Output('supplierreceipt.pdf', 'I');
    }

    // Function to determine the best font size
    private function adjustFontSizeToFitWidth($text, $maxWidth, $initialFontSize, $minFontSize, $characterWidthFactor) {
        $fontSize = $initialFontSize;

        while ($this->calculateTextWidth($text, $fontSize, $characterWidthFactor) > $maxWidth && $fontSize > $minFontSize) {
            $fontSize -= 0.5; // Decrease font size incrementally
        }
        return $fontSize;
    }

    // Function to estimate text width based on character count and font size
    private function calculateTextWidth($text, $fontSize, $characterWidthFactor) {
        return strlen($text) * $fontSize * $characterWidthFactor;
    }

}
?>

.js
var itemsTbl, itemsTblValue = "", SelectedFromItems = "", isConsign = "No", serialProductList = "", productSINoList = "", selectBy = "", mark = 0, Tmark = 0, Area = "-", Warranty = "-";

var branchConsignTbl, branchConsignTblValue = "", SelectedFromBranchConsign = "", ConsignBranchList, totalAddedConsignItem = 0;

var listTbl;
var productTbl, SelectedFromTransProd = "";

$("#category").select2({
    width: '100%',
});
$("#SerialProduct").select2({
    width: '100%',
});
$("#SINo").select2({
    width: '100%',
});

SetTransactionDate();

Initialize();

function SetTransactionDate(){
    var options = {
        value: new Date(),
        rtl: false,
        format: 'm/d/Y',
        timepicker: false,
        datepicker: true,
        startDate: false,
        closeOnDateSelect: false,
        closeOnTimeSelect: true,
        closeOnWithoutClick: true,
        closeOnInputClick: true,
        openOnFocus: true,
        mask: '99/99/9999',
    };

    $('#dateCarrier').datetimepicker(options);
    $('#dateReceivedBy').datetimepicker(options);
    $('#transmittalDateFrom').datetimepicker(options);
    $('#transmittalDateTo').datetimepicker(options);

    // Swal.fire({
    //     title: 'Please Select Transaction Date.',
    //     html: '<input id="DateTransaction" readonly class="swal2-input">',
    //     confirmButtonText: 'Set',
    //     showLoaderOnConfirm: false,
    //     didOpen:function(e){
    //         $('#DateTransaction').datetimepicker(options);
    //     },
    //     allowOutsideClick: false,
    // }).then((result) => {
    //     if (result.isConfirmed) {

    //         if($("#DateTransaction").val() == ""){
    //             location.reload();
    //         }

    //         var date = new Date($("#DateTransaction").val());

    //         $("#transactionDate").val(((date.getMonth() > 8) ? (date.getMonth() + 1) : ('0' + (date.getMonth() + 1))) + '/' + ((date.getDate() > 9) ? date.getDate() : ('0' + date.getDate())) + '/' + date.getFullYear());

    //         $("#transmittalDateFrom").val(((date.getMonth() > 8) ? (date.getMonth() + 1) : ('0' + (date.getMonth() + 1))) + '/' + ((date.getDate() > 9) ? date.getDate() : ('0' + date.getDate())) + '/' + date.getFullYear());

    //         $("#transmittalDateTo").val(((date.getMonth() > 8) ? (date.getMonth() + 1) : ('0' + (date.getMonth() + 1))) + '/' + ((date.getDate() > 9) ? date.getDate() : ('0' + date.getDate())) + '/' + date.getFullYear());
    //     }
    // })
}

function Initialize(){
    $.ajax({
        url:"../../routes/inventorymanagement/transmittalreceipt.route.php",
        type:"POST",
        data:{action:"Initialize"},
        dataType:"JSON",
        beforeSend:function(){
        },
        success:function(response){
            $("#transmittalNo").val(response.TRANSMITNO);
            $("#fromRep").val(response.ORGNAME);

            $("#isynBranch").empty().append(`<option value="" disabled selected>Select</option>`);
            $.each(response.ISYNBRANCH,function(key,value){
                $("#isynBranch").append(`
                    <option value="${value["Stock"]}">
                        ${value["Stock"]}
                    </option>
                `);
            });

            $("#type").empty().append(`<option value="" disabled selected>Select</option>`);
            $.each(response.PRODTYPE,function(key,value){
                $("#type").append(`
                    <option value="${value["Type"]}">
                        ${value["Type"]}
                    </option>
                `);
            });

            itemsTbl = $('#itemsTbl').DataTable({
                searching:false,
                ordering:false,
                info:false,
                paging:false,
                lengthChange:false,
                scrollY: '230px',
                scrollX: true,  
                scrollCollapse: true,
                responsive:false,
                // columnDefs: [
                //     { targets: [ 0,1,2 ], visible:false, searchable:false }
                // ],
            });
        }, 
    })
}

function isConsignmentBox() {
    if ($("#isConsignment").is(":checked")) {
        isConsign = "Yes";
        $('#consignmentBranchContainer').show();
    } else {
        isConsign = "No";
        $('#consignmentBranchContainer').hide();
    }
    $("#isynBranch").val("");
    $("#consignmentBranch").empty().append(`<option value="" disabled selected>Select</option>`);
    $("#type").val("");
    $("#category").empty();
    $("#serialNo").prop("checked", false)
    $("#productName").prop("checked", false)
    $("#SerialProduct").empty();
    $("#SINo").empty();
    ClearProductSummary();
}

function LoadBranch(value){
    if ($("#isConsignment").is(":checked")) {
        $.ajax({
            url:"../../routes/inventorymanagement/transmittalreceipt.route.php",
            type:"POST",
            data:{action:"LoadBranch", value:value},
            dataType:"JSON",
            beforeSend:function(){
            },
            success:function(response){
                $("#consignmentBranch").empty().append(`<option value="" disabled selected>Select</option>`);
                $.each(response.BRANCH,function(key,value){
                    $("#consignmentBranch").append(`
                        <option value="${value["Stock"]}">
                            ${value["Stock"]}
                        </option>
                    `);
                });
    
            }, 
        })
    }
    $("#type").val("");
    $("#category").empty();
    $("#serialNo").prop("checked", false)
    $("#productName").prop("checked", false)
    $("#SerialProduct").empty();
    $("#SINo").empty();
    ClearProductSummary();
}

function forBranchClear(){
    $("#type").val("");
    $("#category").empty();
    $("#serialNo").prop("checked", false)
    $("#productName").prop("checked", false)
}

function LoadCategory(type){
    var isynBranch = $("#isynBranch").val();
    var consignBranch = $("#consignmentBranch").val();

    $.ajax({
        url:"../../routes/inventorymanagement/transmittalreceipt.route.php",
        type:"POST",
        data:{action:"LoadCategory", isConsign:isConsign, type:type, isynBranch:isynBranch, consignBranch:consignBranch},
        dataType:"JSON",
        beforeSend:function(){
        },
        success:function(response){
            $("#category").empty().append(`<option value="" disabled selected>Select</option>`);
            $.each(response.CATEG,function(key,value){
                $("#category").append(`
                    <option value="${value["Category"]}">
                        ${value["Category"]}
                    </option>
                `);
            });
        }, 
    })
    $("#serialNo").prop("checked", false)
    $("#productName").prop("checked", false)
    $("#SerialProduct").empty();
    $("#SINo").empty();
    ClearProductSummary();
}

function LoadSerialProduct(category){
    var type = $("#type").val();
    var isynBranch = $("#isynBranch").val();
    var consignBranch = $("#consignmentBranch").val();
    $("#productName").prop("checked", true)
    selectBy = "productName";

    $.ajax({
        url:"../../routes/inventorymanagement/transmittalreceipt.route.php",
        type:"POST",
        data:{action:"LoadSerialProduct", isConsign:isConsign, type:type, category:category, isynBranch:isynBranch, consignBranch:consignBranch},
        dataType:"JSON",
        beforeSend:function(){
        },
        success:function(response){
            serialProductList = response.SRKPRDT;
            productSINoList = response.PRDTSINO;

            $("#SerialProduct").empty().append(`<option value="" disabled selected>Select</option>`);
            $("#SINo").empty().append(`<option value="" disabled selected>Select</option>`);
            $.each(response.SRKPRDT,function(key,value){
                $("#SerialProduct").append(
                    $('<option></option>')
                        .val(value["Product"])
                        .text(value["Product"])
                );
            });
        }, 
    })
    ClearProductSummary();
}

$("input[name='selectBy']").change(function(){
    $("#SerialProduct").empty().append(`<option value="" disabled selected>Select</option>`);
    $("#SINo").empty().append(`<option value="" disabled selected>Select</option>`);
    selectBy = $(this).val(); 
    if($(this).val() == "serial"){
        $.each(serialProductList,function(key,value){
            $("#SerialProduct").append(`
                <option value="${value["Serialno"]}">
                    ${value["Serialno"]}
                </option>
            `);
        });
    }else if($(this).val() == "productName"){
        $.each(serialProductList,function(key,value){
            $("#SerialProduct").append(
                $('<option></option>')
                    .val(value["Product"])
                    .text(value["Product"])
            );
        });
    }
    ClearProductSummary();
})

function LoadProductSINo (SerialProduct){
    $("#SINo").empty().append(`<option value="" disabled selected>Select</option>`);
    $.each(serialProductList,function(key,value){
        if(value["Serialno"] == SerialProduct || value["Product"] == SerialProduct){
            $("#SINo").append(`
                <option value="${value["SIno"]}">
                    ${value["SIno"]}
                </option>
            `);
        }
    });
    ClearProductSummary();
}

function LoadProductSummary(){
    var isynBranch = $("#isynBranch").val();
    var consignBranch = $("#consignmentBranch").val();
    var type = $("#type").val();
    var category = $("#category").val();
    var serialProduct = $("#SerialProduct").val();
    var SINo = $("#SINo").val();

    $.ajax({
        url:"../../routes/inventorymanagement/transmittalreceipt.route.php",
        type:"POST",
        data:{action:"LoadProductSummary", isConsign:isConsign, selectBy:selectBy, type:type, category:category, serialProduct:serialProduct, SINo:SINo, isynBranch:isynBranch, consignBranch:consignBranch},
        dataType:"JSON",
        beforeSend:function(){
        },
        success:function(response){
            let info =  response.PSUMMARY;
            $('#psSupplierSI').val(info["SIno"]);
            $('#psSerialNo').val(info["Serialno"]);
            $('#psProduct').val(info["Product"]);
            $('#psSupplier').val(info["Supplier"]);
            $('#psSRP').val(formatAmtVal(info["SRP"]));
            $('#srpMerchSales').val(formatAmtVal(info["SRP"]));
            $('#psQuantity').val(info["Quantity"]);
            $('#psDealerPrice').val(formatAmtVal(info["DealerPrice"]));
            $('#psTotalPrice').val(formatAmtVal(info["TotalPrice"]));
            $('#finalSRP').val(formatAmtVal(info["SRP"]));
            Warranty = info["Warranty"];
        }, 
    })
}

function ComputeAvailQty(qty){
    var psQty = $('#psQuantity').val();

    if (qty == 0 || qty == null || qty == "") {
        Swal.fire({
            icon: "warning",
            title: "Please enter desired quantity.",
        });
        return false;
    }

    if (parseFloat(qty) > parseFloat(psQty)) {  
        Swal.fire({
            icon: "warning",
            title: "Insufficient available product quantity.",
        });
        $('#saleQty').val("");
        return false;
    }
}

function isEditSRPBTN() {
    if ($("#isEditSRP").is(":checked")) {
        $('#finalSRP').prop("disabled", false);
    } else {
        let  actualSRP = $('#psSRP').val();
        $('#finalSRP').prop("disabled", true);
        $('#finalSRP').val(actualSRP);
    }
}

function ClearProductSummary(){
    $('#psSupplierSI').val("");
    $('#psSerialNo').val("");
    $('#psProduct').val("");
    $('#psSupplier').val("");
    $('#psSRP').val("");
    $('#psQuantity').val("");
    $('#psDealerPrice').val("");
    $('#psTotalPrice').val("");
    $('#saleQty').val("");
    $('#finalSRP').val("");
}

function ClearAllFields(){
    isConsign = "No";    
    $("#isConsignment").prop("checked", false)
    $('#consignmentBranchContainer').hide();
    $("#isynBranch").val("");
    $("#consignmentBranch").empty().append(`<option value="" disabled selected>Select</option>`);
    $("#type").val("");
    $("#category").empty();
    $("#serialNo").prop("checked", false)
    $("#productName").prop("checked", false)
    $("#SerialProduct").empty();
    $("#SINo").empty();
    ClearProductSummary();
}

// =======================================================================================

function addItem() {
    let transactionDate = $('#transactionDate').val();
    let isConsignment = "-";
    let branch = "-";
    if ($('#isConsignment').is(':checked')){
        branch = $('#consignmentBranch').val();
    } else {
        branch = $('#isynBranch').val();
    }
    let type = $('#type').val();
    let categ = $('#category').val();
    let serialProduct = $('#SerialProduct').val();
    let SINo = $('#SINo').val();

    let supplierSI = $('#psSupplierSI').val();
    let serialNo = $('#psSerialNo').val();
    let productName = $('#psProduct').val();
    let supplierName = $('#psSupplier').val();
    let psSRP = $('#psSRP').val().replace(/,/g, '');
    let psQty = $('#psQuantity').val();
    let psDealerPrice = $('#psDealerPrice').val().replace(/,/g, '');
    let psTotalPrice = $('#psTotalPrice').val().replace(/,/g, '');
    
    let saleQty = $('#saleQty').val();
    let editSRP = $('#finalSRP').val().replace(/,/g, '');

    let total = 0;
    if ($('#isEditSRP').is(':checked')){
        total = parseFloat(saleQty) * parseFloat(editSRP);
    } else {
        total = parseFloat(saleQty) * parseFloat(psSRP);
    }

    let ProductSerialNo = "";
    if (serialNo == "-"){
        ProductSerialNo = productName;
    } else {
        ProductSerialNo = productName + "S/N:" + serialNo;
    }

    if (isynBranch == null || type == null || categ == null || serialProduct == null || SINo == null) {
        Swal.fire({
            icon: 'warning',
            text: 'Please complete Product Information.',
        });
        return;
    }
    
    if (saleQty == "" || saleQty == null) {
        Swal.fire({
            icon: 'warning',
            text: 'Please enter desired quantity amount.',
        });
        return;
    }

    var values = [supplierSI, serialNo, categ, type, branch];
    var indexes = [3, 4, 7, 8, 9];

    // Get all rows' data
    var rows = itemsTbl.rows().data().toArray();

    // Check each row
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var allMatch = true;

        // Compare each value with the corresponding column in this row
        for (var j = 0; j < values.length; j++) {
            var columnValue = row[indexes[j]];
            var searchValue = values[j];

            // Case-insensitive comparison; modify as needed
            if (columnValue.toString().toLowerCase() !== searchValue.toString().toLowerCase()) {
                allMatch = false;
                break;
            }
        }

        if (allMatch) {
            Swal.fire({
                icon: 'warning',
                title: 'Item is already added, please check.',
            })
            return;
        }
    }
    
    itemsTbl.row.add([
        ProductSerialNo,
        saleQty,
        formatAmtVal(total),
        supplierSI,
        serialNo,
        productName,
        supplierName,
        categ,
        type,
        branch,
    ]).draw(false);

    ClearAllFields();
};

$('#itemsTbl tbody').on('click', 'tr',function(e){
    if(itemsTbl.rows().count() !== 0){
        let classList = e.currentTarget.classList;
        if (classList.contains('selected')) {
            classList.remove('selected');
            $("#cancelProduct").attr("disabled",true);
            itemTblValue = "";
            SelectedFromItems = "";
        } else {
            itemsTbl.rows('.selected').nodes().each((row) => {
                row.classList.remove('selected');
            });
            classList.add('selected');
            $("#cancelProduct").attr("disabled",false);
            itemsTblValue = $('#itemsTbl').DataTable().row(this).data();
            SelectedFromItems = this;
        }
    }
});

function cancelProduct(){
    if  (SelectedFromItems != "") {
        itemsTbl.row(SelectedFromItems).remove().draw(false);
        SelectedFromItems = "";
        $("#cancelProduct").attr("disabled",true);
    } else {
        SelectedFromItems = "";
        Swal.fire({
            icon: 'warning',
            title: 'Please select from the Items to delete',
        })
    }
}

function ClearPurchasedBy(){
    $('#customerType').val("").prop('disabled', false);
    $('#customerNameInputDiv').show();
    $('#customerNameInput').prop('disabled', false);
    $('#customerNameInput').prop('readonly', true);
    $('#customerNameInput').val("");
    $('#customerNameSelectDiv').hide();
    $('#customerNameSelect').val("").prop('disabled', false);

    $("#staffCheckbox").prop("checked", false);
    $("#branchUsed").prop("checked", false);
    $("mfiUsed").prop("checked", false);
    $("#staffCheckbox").prop("disabled", false);
    $("#branchUsed").prop("disabled", false);
    $("mfiUsed").prop("disabled", false);

    $('#tinNoinput').val("").prop('disabled', false);
    $('#fullAddress').val("").prop('disabled', false);
    $('#status').val("").prop('disabled', false);
}

function parseDate(dateStr) {
    let [month, day, year] = dateStr.split("/").map(Number);
    return new Date(year, month - 1, day); // Month is 0-based in JS
}

function SubmitBtn(){
    var clientTo = $('#toRep').val();

    if (clientTo == "") {
        Swal.fire({
            icon: 'warning',
            title: 'Please enter a recipient name',
        })
        return;
    }

    if ($('#isOtherDetails').is(':checked')){
        var carrier = $('#carrier').val();
        var receiver = $('#receivedBy').val();
        if (carrier == "" || receiver == ""){
            Swal.fire({
                icon: 'warning',
                title: 'Please fill in the Carrier and Received By fields',
            })
            return;
        }
    }

    if(itemsTbl.rows().count() !== 0){
        let Data = itemsTbl.rows().data().toArray();
        let formdata = new FormData();
        formdata.append("action","SubmitInvOut");
        formdata.append("DATA",JSON.stringify(Data));

        Swal.fire({
            icon: 'info',
            title: 'Proceed to submit entries?',
            showCancelButton: true,
            // allowOutsideClick: false,
            preConfirm: function() {
                return $.ajax({
                    url: "../../routes/inventorymanagement/transmittalreceipt.route.php",
                    type: "POST",
                    data:formdata,
                    processData:false,
                    cache:false,
                    contentType:false,
                    dataType:"JSON",
                    beforeSend: function() {
                        console.log('Processing Request...')
                    },
                    success: function(response) {
                        if(response.STATUS != "success"){
                            Swal.showValidationMessage(
                                response.MESSAGE,
                            )
                        }
                    },
                });
            },
        }).then(function(result) {
            if (result.isConfirmed) {
                if (result.value.STATUS == 'success') {
                    Swal.fire({
                        icon: "success",
                        title: "Success",
                        text: result.value.MESSAGE,
                    });
                    window.open("../../routes/inventorymanagement/transmittalreceipt.route.php?type=PrintSalesInvoice");
                    LoadTransaction();
                    ClearAllFields();
                    ClearPurchasedBy();
                    Initialize();
                } else if (result.value.STATUS != 'success') {
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: result.value.MESSAGE,
                    });
                }                
            }
        });

    } else {
        Swal.fire({
            icon: 'warning',
            title: 'No Entries available.',
        });
     }
}

// =======================================================================================

function SearchTransmittal(){    
    $("#listList").empty();
    $("#rePrint").prop("disabled", true);
    $("#SearchTransmittalMDL").modal("show");
}

function TransmittalSearch(){
    var nameFrom = $("#searchNameFrom").val();
    console.log("Search function called with:", nameFrom);

    if (nameFrom == "") {
        console.log("Empty search term - showing warning");
        Swal.fire({
            icon: 'warning',
            title: 'Please enter sender name.',
        })
        return;
    }

    console.log("Making AJAX call to:", "../../routes/inventorymanagement/transmittalreceipt.route.php");
    console.log("Sending data:", {action:"TransmittalSearch",nameFrom:nameFrom});

    $.ajax({
        url:"../../routes/inventorymanagement/transmittalreceipt.route.php",
        type:"POST",
        data:{action:"TransmittalSearch",nameFrom:nameFrom},
        dataType:"JSON",
        beforeSend:function(){
            console.log("Before send - clearing table");
            if ( $.fn.DataTable.isDataTable( '#listTbl' ) ) {
                $('#listTbl').DataTable().clear();
                $('#listTbl').DataTable().destroy(); 
            }

            $("#rePrint").prop("disabled", true);
        },
        success:function(response){
            console.log("AJAX success - response:", response);
            $("#listList").empty();
            $.each(response.TRANSACTIONLIST,function(key,value){
                console.log("Adding row:", value);
                $("#listList").append(`
                    <tr>
                        <td>${value["TransmittalNO"]}</td>
                        <td>${value["NameTO"]}</td>
                        <td>${value["DatePrepared"]}</td>
                        <td>${value["isOUT"]}</td>
                        <td>${value["SalesInvoice"]}</td>
                    </tr>
                `);
            });

            listTbl = $('#listTbl').DataTable({
                searching:false,
                ordering:false,
                info:false,
                paging:false,
                lengthChange:false,
                scrollY: '230px',
                scrollX: true,
                scrollCollapse: true,
                responsive:false,
            });
            console.log("DataTable created");
        },
        error: function(xhr, status, error) {
            console.error("AJAX error:", error);
            console.error("Status:", status);
            console.error("Response text:", xhr.responseText);
            console.error("Ready state:", xhr.readyState);
            console.error("Status code:", xhr.status);
            Swal.fire({
                icon: 'error',
                title: 'Search Error',
                text: 'Failed to search. Check console for details.'
            });
        }
    })
}

// Function to clear search
function ClearSearch(){
    $("#searchNameFrom").val("");
    $("#listList").empty();
    $("#rePrint").prop("disabled", true);
    
    if ( $.fn.DataTable.isDataTable( '#listTbl' ) ) {
        $('#listTbl').DataTable().clear();
        $('#listTbl').DataTable().destroy(); 
    }
}

$('#listTbl tbody').on('click', 'tr',function(e){
    if(listTbl.rows().count() !== 0){
        let classList = e.currentTarget.classList;
        if (classList.contains('selected')) {
            classList.remove('selected');
            $("#rePrint").prop("disabled", true);
        } else {
            listTbl.rows('.selected').nodes().each((row) => {
                row.classList.remove('selected');
            });
            classList.add('selected');
            $("#rePrint").prop("disabled", false);
        }
    }
});

// =======================================================================================

function isOtherDetailsBox() {
    if ($("#isOtherDetails").is(":checked")) {
        $("#carrier").prop("disabled", false);
        $("#dateCarrier").prop("disabled", false);
        $("#receivedBy").prop("disabled", false);
        $("#dateReceivedBy").prop("disabled", false);
    } else {
        $("#carrier").prop("disabled", true);
        $("#dateCarrier").prop("disabled", true);
        $("#receivedBy").prop("disabled", true);
        $("#dateReceivedBy").prop("disabled", true);
    }
}
// =======================================================================================

function formatAmtVal(value) {
    // Remove any characters that are not digits, commas, or periods
    let cleanValue = value.toString().replace(/[^0-9.,]/g, '');
    // Remove commas for formatting purposes
    cleanValue = cleanValue.replace(/,/g, '');
    if (cleanValue !== '') {
        // Parse the cleaned value to a float and ensure two decimal places
        let formattedValue = parseFloat(cleanValue).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return formattedValue; // Return the formatted value
    }    
    return '0.00'; // Return an empty string if input is invalid or empty
}

function formatInput(input) {
    // Get the value from the input field and remove invalid characters
    let cleanValue = input.value.replace(/[^0-9.,-]/g, '');

    // Check for negative values
    if (cleanValue.includes('-')) {
        // Show SweetAlert message
        Swal.fire({
            icon: 'error',
            title: 'Invalid Amount',
            text: 'Negative amounts are not allowed.',
            confirmButtonText: 'OK'
        });

        // Reset the input field
        input.value = '0.00';
        return;
    }

    // Remove commas for numeric processing
    cleanValue = cleanValue.replace(/,/g, '');

    if (cleanValue !== '') {
        // Parse the cleaned value to a float and ensure two decimal places
        let formattedValue = parseFloat(cleanValue).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        // Set the formatted value back to the input field
        input.value = formattedValue;
    } else {
        input.value = '0.00'; // If empty or invalid, set input to empty
    }
}

// Function to fetch products for the selected transmittal
function fetchProducts(transNo) {
    $.ajax({
        url: "../../routes/inventorymanagement/transmittalreceipt.route.php",
        type: "POST",
        data: {action: "fetchProducts", transNo: transNo},
        dataType: "JSON",
        beforeSend: function() {
            $("#productList").empty();
        },
        success: function(response) {
            $("#productList").empty();
            if (response.PRODUCTS && response.PRODUCTS.length > 0) {
                $.each(response.PRODUCTS, function(key, value) {
                    $("#productList").append(`
                        <tr>
                            <td>${value["ProductSerialNo"] || ''}</td>
                            <td>${value["Quantity"] || ''}</td>
                            <td>${value["SRP"] || ''}</td>
                            <td>${value["SINo"] || ''}</td>
                            <td>${value["SerialNo"] || ''}</td>
                            <td>${value["ProductName"] || ''}</td>
                            <td>${value["Supplier"] || ''}</td>
                            <td>${value["Category"] || ''}</td>
                            <td>${value["Type"] || ''}</td>
                            <td>${value["Branch"] || ''}</td>
                        </tr>
                    `);
                });
            }
        },
        error: function(xhr, status, error) {
            console.error("Error fetching products:", error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to fetch product details'
            });
        }
    });
}

// Function to reprint the selected transmittal
function RePrint() {
    var selectedRow = $('#listTbl tbody tr.selected');
    
    if (selectedRow.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'No Selection',
            text: 'Please select a transmittal to reprint'
        });
        return;
    }
    
    var val = $('#listTbl').DataTable().row(selectedRow).data();
    var transNo = val[0];
    
    // Open the reprint in a new window
    window.open("../../routes/inventorymanagement/transmittalreceipt.route.php?type=RePrintTransmittal&transNo=" + transNo, "_blank");
}
